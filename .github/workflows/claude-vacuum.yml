name: Daily Code Cleanup

on:
  schedule:
    - cron: "0 9 * * *" # Every day at 4am ET (9:00 UTC)
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: "1.8.3"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.12-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run Claude Code Cleanup
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            issues: write
            pull-requests: write
            contents: write
          prompt: |
            Perform a codebase cleanup. You must create a new branch for any changes.

            Focus on these three areas:
            1. **Redundant Comments:** Review code against patterns in Claude.MD. Remove comments that explain 'what' the code does if the code is self-documenting.
            2. **Inline Imports:** Identify and consolidate inline imports into top-level imports unless there is a specific performance reason to keep them.
            3. **Defensive Over-engineering:** Remove unnecessary guards, redundant type casts, or excessively defensive code that clutters logic without adding safety (you may check with curl or search to find http responses).

            If changes are made:
            - Create a branch named 'maintenance/daily-cleanup-${{ github.run_id }}'
            - Commit the changes.
            - Push the branch and open a PR to main.
            - Summarize your changes in the PR description.
          model: claude-opus-4-6
          claude_args: |
            --verbose --allowedTools "Read,Write,Edit,Bash(*),WebSearch,WebFetch"
